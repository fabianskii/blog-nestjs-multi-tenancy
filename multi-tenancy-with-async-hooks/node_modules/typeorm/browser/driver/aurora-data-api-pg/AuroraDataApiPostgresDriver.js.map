{"version":3,"sources":["../browser/src/driver/aurora-data-api-pg/AuroraDataApiPostgresDriver.ts"],"names":[],"mappings":";AACA,OAAO,EAAC,cAAc,EAAC,MAAM,4BAA4B,CAAC;AAC1D,OAAO,EAAC,aAAa,EAAC,MAAM,8BAA8B,CAAC;AAG3D,OAAO,EAAC,gCAAgC,EAAC,MAAM,wDAAwD,CAAC;AAGxG;IAAuC,mCAAc;IAArD;;IAIA,CAAC;IAAD,sBAAC;AAAD,CAJA,AAIC,CAJsC,cAAc,GAIpD;AAED;IAAiD,+CAAe;IAgC5D,4EAA4E;IAC5E,cAAc;IACd,4EAA4E;IAE5E,qCAAY,UAAsB;QAAlC,YACI,iBAAO,SAiBV;QAhBG,KAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,KAAI,CAAC,OAAO,GAAG,UAAU,CAAC,OAAiD,CAAC;QAC5E,KAAI,CAAC,YAAY,GAAG,KAAK,CAAC;QAE1B,wBAAwB;QACxB,KAAI,CAAC,gBAAgB,EAAE,CAAC;QAExB,KAAI,CAAC,MAAM,GAAG,IAAI,KAAI,CAAC,aAAa,CAChC,KAAI,CAAC,OAAO,CAAC,MAAM,EACnB,KAAI,CAAC,OAAO,CAAC,SAAS,EACtB,KAAI,CAAC,OAAO,CAAC,WAAW,EACxB,KAAI,CAAC,OAAO,CAAC,QAAQ,EACrB,UAAC,KAAa,EAAE,UAAkB,IAAK,OAAA,KAAI,CAAC,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,KAAK,EAAE,UAAU,CAAC,EAAlD,CAAkD,EACzF,KAAI,CAAC,OAAO,CAAC,oBAAoB,EACjC,KAAI,CAAC,OAAO,CAAC,aAAa,CAC7B,CAAC;;IACN,CAAC;IAED,4EAA4E;IAC5E,6BAA6B;IAC7B,4EAA4E;IAE5E;;;;OAIG;IACG,6CAAO,GAAb;;;;;;KACC;IAED;;OAEG;IACG,gDAAU,GAAhB;;;;;;KACC;IAED;;OAEG;IACH,uDAAiB,GAAjB,UAAkB,IAAqB;QACnC,OAAO,IAAI,gCAAgC,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;IAC5D,CAAC;IAED,4EAA4E;IAC5E,oBAAoB;IACpB,4EAA4E;IAE5E;;OAEG;IACO,sDAAgB,GAA1B;QACY,IAAA,4DAAE,CAA0D;QAEpE,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;IAC5B,CAAC;IAED;;OAEG;IACO,kDAAY,GAAtB,UAAuB,UAAe,EAAE,KAAa;QACjD,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;IACpC,CAAC;IAED;;OAEG;IACG,kDAAY,GAAlB;;;;;4BAC+B,qBAAM,IAAI,CAAC,0BAA0B,EAAE,EAAA;;wBAA5D,kBAAkB,GAAG,SAAuC;6BAE9D,kBAAkB,CAAC,aAAa,EAAhC,wBAAgC;wBAChC,qBAAM,IAAI,CAAC,gBAAgB,CAAC,kBAAkB,EAAE,IAAI,CAAC,UAAU,CAAC,EAAA;;wBAAhE,SAAgE,CAAC;;4BAGrE,sBAAO,OAAO,CAAC,OAAO,EAAE,EAAC;;;;KAC5B;IACL,kCAAC;AAAD,CAjHA,AAiHC,CAjHgD,eAAe,GAiH/D","file":"AuroraDataApiPostgresDriver.js","sourcesContent":["import {Driver} from \"../Driver\";\nimport {PostgresDriver} from \"../postgres/PostgresDriver\";\nimport {PlatformTools} from \"../../platform/PlatformTools\";\nimport {Connection} from \"../../connection/Connection\";\nimport {AuroraDataApiPostgresConnectionOptions} from \"../aurora-data-api-pg/AuroraDataApiPostgresConnectionOptions\";\nimport {AuroraDataApiPostgresQueryRunner} from \"../aurora-data-api-pg/AuroraDataApiPostgresQueryRunner\";\nimport {ReplicationMode} from \"../types/ReplicationMode\";\n\nabstract class PostgresWrapper extends PostgresDriver {\n    options: any;\n\n    abstract createQueryRunner(mode: ReplicationMode): any;\n}\n\nexport class AuroraDataApiPostgresDriver extends PostgresWrapper implements Driver {\n\n    // -------------------------------------------------------------------------\n    // Public Properties\n    // -------------------------------------------------------------------------\n\n    /**\n     * Connection used by driver.\n     */\n    connection: Connection;\n\n    /**\n     * Aurora Data API underlying library.\n     */\n    DataApiDriver: any;\n\n    client: any;\n\n    // -------------------------------------------------------------------------\n    // Public Implemented Properties\n    // -------------------------------------------------------------------------\n\n    /**\n     * Connection options.\n     */\n    options: AuroraDataApiPostgresConnectionOptions;\n\n    /**\n     * Master database used to perform all write queries.\n     */\n    database?: string;\n\n    // -------------------------------------------------------------------------\n    // Constructor\n    // -------------------------------------------------------------------------\n\n    constructor(connection: Connection) {\n        super();\n        this.connection = connection;\n        this.options = connection.options as AuroraDataApiPostgresConnectionOptions;\n        this.isReplicated = false;\n\n        // load data-api package\n        this.loadDependencies();\n\n        this.client = new this.DataApiDriver(\n            this.options.region,\n            this.options.secretArn,\n            this.options.resourceArn,\n            this.options.database,\n            (query: string, parameters?: any[]) => this.connection.logger.logQuery(query, parameters),\n            this.options.serviceConfigOptions,\n            this.options.formatOptions,\n        );\n    }\n\n    // -------------------------------------------------------------------------\n    // Public Implemented Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Performs connection to the database.\n     * Based on pooling options, it can either create connection immediately,\n     * either create a pool and create connection when needed.\n     */\n    async connect(): Promise<void> {\n    }\n\n    /**\n     * Closes connection with database.\n     */\n    async disconnect(): Promise<void> {\n    }\n\n    /**\n     * Creates a query runner used to execute database queries.\n     */\n    createQueryRunner(mode: ReplicationMode) {\n        return new AuroraDataApiPostgresQueryRunner(this, mode);\n    }\n\n    // -------------------------------------------------------------------------\n    // Protected Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * If driver dependency is not given explicitly, then try to load it via \"require\".\n     */\n    protected loadDependencies(): void {\n        const { pg } = PlatformTools.load(\"typeorm-aurora-data-api-driver\");\n\n        this.DataApiDriver = pg;\n    }\n\n    /**\n     * Executes given query.\n     */\n    protected executeQuery(connection: any, query: string) {\n        return this.client.query(query);\n    }\n\n    /**\n     * Makes any action after connection (e.g. create extensions in Postgres driver).\n     */\n    async afterConnect(): Promise<void> {\n        const extensionsMetadata = await this.checkMetadataForExtensions();\n\n        if (extensionsMetadata.hasExtensions) {\n            await this.enableExtensions(extensionsMetadata, this.connection);\n        }\n\n        return Promise.resolve();\n    }\n}\n"],"sourceRoot":"../.."}